{{ define "main" }}

<section class="section pt-4">
    <div class="container">
        <div class="row">
            <div class="col-lg-9  mb-5 mb-lg-0">
                <div id="search-results"></div>
                <div class="search-loading">Loading...</div>
            </div>
            <aside class="col-lg-3">
                {{ partial "sidebar.html" . }}
            </aside>
        </div>
    </div>
</section>



<script id="search-result-template" type="text/x-js-template">
    <div class="card mb-4 shadow-sm">
        <div class="row">
            <div class="col-md-5">
                <img class="ratio ratio-4x3 rounded-0" src="${link}${img}" alt="">
            </div>
            <div class="col-md-7 mt-3 mt-md-0">
                {{ range .Params.categories }}
                <a href="{{ " /categories/" | relLangURL }}{{ . | urlize }}" class="badge bg-category bg-category-{{ . }} bg-opacity-15 text-category text-category-{{ . }} my-3"><i
                        class="fas fa-circle me-2 small fw-bold"></i>{{ . }} </a>
                {{ end }}
                <h3 class="h5"><a href="${link}" class="btn-link text-reset">${title}</a></h3>
                <p>${snippet}</p>
                <!-- Card info -->
                <ul class="nav nav-divider align-items-center d-none d-sm-inline-block">
                    <li class="nav-item">
                        <div class="nav-link ps-0">
                            <div class="d-flex align-items-center position-relative">
                                <img class="ratio ratio-1x1 rounded-circle" src='https://www.gravatar.com/avatar/{{ md5 .Site.Params.authorEmail }}?s=35&d=identicon' alt="avatar">
                                <span class="ms-3">by&nbsp;{{ .Site.Params.Author }}</span>
                            </div>
                        </div>
                    </li>
                    <li class="nav-item">${date}</li>
                </ul>
            </div>
        </div>
    </div>
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"
    integrity="sha512-Nqw1tH3mpavka9cQCc5zWWEZNfIPdOYyQFjlV1NvflEtQ0/XI6ZQ+H/D3YgJdqSUJlMLAPRj/oXlaHCFbFCjoQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js"
    integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    var summaryInclude = 180;
    var fuseOptions = {
        shouldSort: true,
        includeMatches: true,
        includeScore: true,
        tokenize: true,
        location: 0,
        distance: 100,
        minMatchCharLength: 1,
        keys: [
            { name: "title", weight: 0.45 },
            { name: "contents", weight: 0.4 },
            { name: "tags", weight: 0.1 },
            { name: "categories", weight: 0.05 }
        ]
    };

    // =============================
    // Search
    // =============================

    var inputBox = document.getElementById('search-query');
    if (inputBox !== null) {
        var searchQuery = param("q");
        if (searchQuery) {
            inputBox.value = searchQuery || "";
            executeSearch(searchQuery, false);
        } else {
            document.getElementById('search-results').innerHTML = '<p class="search-results-empty">Please enter a word or phrase above, or see <a href="/tags/">all tags</a>.</p>';
        }
    }

    function executeSearch(searchQuery) {

        show(document.querySelector('.search-loading'));

        fetch('/index.json').then(function (response) {
            if (response.status !== 200) {
                console.log('Looks like there was a problem. Status Code: ' + response.status);
                return;
            }
            // Examine the text in the response
            response.json().then(function (pages) {
                var fuse = new Fuse(pages, fuseOptions);
                var result = fuse.search(searchQuery);
                if (result.length > 0) {
                    populateResults(result);
                } else {
                    document.getElementById('search-results').innerHTML = '<p class=\"search-results-empty\">No matches found</p>';
                }
                hide(document.querySelector('.search-loading'));
            })
                .catch(function (err) {
                    console.log('Fetch Error :-S', err);
                });
        });
    }

    function populateResults(results) {

        var searchQuery = document.getElementById("search-query").value;
        var searchResults = document.getElementById("search-results");

        // pull template from hugo template definition
        var templateDefinition = document.getElementById("search-result-template").innerHTML;

        results.forEach(function (value, key) {

            var contents = value.item.contents;
            var snippet = "";
            var snippetHighlights = [];

            snippetHighlights.push(searchQuery);
            snippet = contents.substring(0, summaryInclude * 2) + '&hellip;';

            //replace values
            var tags = ""
            if (value.item.tags) {
                value.item.tags.forEach(function (element) {
                    tags = tags + "<a href='/tags/" + element + "'>" + "#" + element + "</a> "
                });
            }

            var output = render(templateDefinition, {
                key: key,
                title: value.item.title,
                link: value.item.permalink,
                tags: tags,
                categories: value.item.categories,
                snippet: snippet,
                img: value.item.img,
                date: value.item.pubDate
            });
            searchResults.innerHTML += output;

            snippetHighlights.forEach(function (snipvalue, snipkey) {
                var instance = new Mark(document.getElementById('summary-' + key));
                instance.mark(snipvalue);
            });

        });
    }

    function render(templateString, data) {
        var conditionalMatches, conditionalPattern, copy;
        conditionalPattern = /\$\{\s*isset ([a-zA-Z]*) \s*\}(.*)\$\{\s*end\s*}/g;
        //since loop below depends on re.lastInxdex, we use a copy to capture any manipulations whilst inside the loop
        copy = templateString;
        while ((conditionalMatches = conditionalPattern.exec(templateString)) !== null) {
            if (data[conditionalMatches[1]]) {
                //valid key, remove conditionals, leave contents.
                copy = copy.replace(conditionalMatches[0], conditionalMatches[2]);
            } else {
                //not valid, remove entire section
                copy = copy.replace(conditionalMatches[0], '');
            }
        }
        templateString = copy;
        //now any conditionals removed we can do simple substitution
        var key, find, re;
        for (key in data) {
            find = '\\$\\{\\s*' + key + '\\s*\\}';
            re = new RegExp(find, 'g');
            templateString = templateString.replace(re, data[key]);
        }
        return templateString;
    }

    // Helper Functions
    function show(elem) {
        elem.style.display = 'block';
    }
    function hide(elem) {
        elem.style.display = 'none';
    }
    function param(name) {
        return decodeURIComponent((location.search.split(name + '=')[1] || '').split('&')[0]).replace(/\+/g, ' ');
    }

</script>
{{ end }}